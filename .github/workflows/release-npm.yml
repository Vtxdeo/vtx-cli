name: Release - npm

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

jobs:
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Sync version
        shell: bash
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          version = "${{ inputs.version }}"

          pkg = Path("npm/package.json")
          if pkg.exists():
              data = json.loads(pkg.read_text())
              data["version"] = version
              if "optionalDependencies" in data:
                  data["optionalDependencies"] = {
                      name: version for name in data["optionalDependencies"].keys()
                  }
              pkg.write_text(json.dumps(data, indent=2) + "\n")
              print(f"Updated main package to {version}")

          for pkg in Path("npm/platforms").glob("*/package.json"):
              data = json.loads(pkg.read_text())
              data["version"] = version
              pkg.write_text(json.dumps(data, indent=2) + "\n")
              print(f"Updated {pkg.parent.name} to {version}")
          PY

      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          registry-url: "https://registry.npmjs.org"

      - name: Validate npm package metadata
        shell: bash
        run: |
          set -euo pipefail

          version="${{ inputs.version }}"

          optional_deps="$(node -p "Object.keys(require('./npm/package.json').optionalDependencies || {}).join(',')")"
          if [ -z "$optional_deps" ]; then
            echo "No optionalDependencies found in npm/package.json" >&2
            exit 1
          fi

          mismatch=()
          for dep in $(echo "$optional_deps" | tr ',' ' '); do
            dep_version="$(node -p "require('./npm/package.json').optionalDependencies['$dep']")"
            if [ "$dep_version" != "$version" ]; then
              mismatch+=("$dep@$dep_version")
            fi
          done
          if [ "${#mismatch[@]}" -ne 0 ]; then
            echo "Optional dependency versions do not match $version: ${mismatch[*]}" >&2
            exit 1
          fi

          missing_packages=()
          for dep in $(echo "$optional_deps" | tr ',' ' '); do
            pkg_dir="npm/platforms/cli-${dep##*/cli-}"
            if [ ! -d "$pkg_dir" ]; then
              missing_packages+=("$dep")
              continue
            fi
            pkg_version="$(node -p "require('./$pkg_dir/package.json').version")"
            if [ "$pkg_version" != "$version" ]; then
              echo "Version mismatch in $pkg_dir ($pkg_version != $version)" >&2
              exit 1
            fi
          done

          if [ "${#missing_packages[@]}" -ne 0 ]; then
            echo "Missing platform package dirs for: ${missing_packages[*]}" >&2
            exit 1
          fi

      - name: Download Binary Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: binary-*

      - name: Verify Binary Artifacts
        shell: bash
        run: |
          set -euo pipefail

          expected=()
          for pkg in npm/platforms/cli-*; do
            if [ -d "$pkg" ]; then
              platform="${pkg##*/cli-}"
              expected+=("$platform")
            fi
          done

          if [ "${#expected[@]}" -eq 0 ]; then
            echo "No platform packages found under npm/platforms/cli-*" >&2
            exit 1
          fi

          missing=()
          for platform in "${expected[@]}"; do
            if [ ! -d "artifacts/binary-$platform" ]; then
              missing+=("$platform")
            fi
          done

          if [ "${#missing[@]}" -ne 0 ]; then
            echo "Missing binary artifacts for: ${missing[*]}" >&2
            exit 1
          fi

          extra=()
          for artifact in artifacts/binary-*; do
            if [ -d "$artifact" ]; then
              platform="${artifact##*/binary-}"
              found=false
              for expected_platform in "${expected[@]}"; do
                if [ "$platform" = "$expected_platform" ]; then
                  found=true
                  break
                fi
              done
              if [ "$found" = "false" ]; then
                extra+=("$platform")
              fi
            fi
          done

          if [ "${#extra[@]}" -ne 0 ]; then
            echo "Unexpected binary artifacts for: ${extra[*]}" >&2
            exit 1
          fi

      - name: Assemble Platform Binaries
        shell: bash
        run: |
          set -euo pipefail

          for artifact in artifacts/binary-*; do
            if [ ! -d "$artifact" ]; then
              continue
            fi

            platform="${artifact##*/}"
            platform="${platform#binary-}"
            bin_dir="npm/platforms/cli-${platform}/bin"
            mkdir -p "$bin_dir"

            mapfile -t files < <(find "$artifact" -maxdepth 1 -type f)
            if [ "${#files[@]}" -eq 0 ]; then
              echo "No binary found in $artifact" >&2
              exit 1
            fi
            if [ "${#files[@]}" -gt 1 ]; then
              echo "Multiple binaries found in $artifact" >&2
              exit 1
            fi

            src="${files[0]}"
            dest="$bin_dir/$(basename "$src")"
            mv "$src" "$dest"

            if [[ "$platform" != win32-* ]]; then
              chmod +x "$dest"
            fi
          done

          for pkg in npm/platforms/cli-*; do
            bin_dir="$pkg/bin"
            if [ ! -d "$bin_dir" ] || [ -z "$(ls -A "$bin_dir")" ]; then
              echo "Missing binary for $pkg" >&2
              exit 1
            fi
          done

      - name: Publish Platform Packages
        shell: bash
        run: |
          set -euo pipefail

          for platform in npm/platforms/*; do
            if [ -d "$platform" ]; then
              pkg_name="$(node -p "require('./$platform/package.json').name")"
              pkg_version="$(node -p "require('./$platform/package.json').version")"
              echo "Publishing $platform ($pkg_name@$pkg_version)..."
              cd "$platform"
              if [ "$pkg_name" = "@vtxdeo/cli-linux-x64" ]; then
                npm_publish_cmd="npm publish --access public --verbose"
              else
                npm_publish_cmd="npm publish --access public"
              fi
              if $npm_publish_cmd; then
                echo "Published $pkg_name@$pkg_version"
              else
                echo "Publish failed for $pkg_name@$pkg_version, checking if already exists..."
                if npm view "$pkg_name@$pkg_version" version >/dev/null 2>&1; then
                  echo "Already published $pkg_name@$pkg_version, continuing."
                else
                  echo "Missing $pkg_name@$pkg_version on npm after publish failure." >&2
                  exit 1
                fi
              fi
              cd - >/dev/null
            fi
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}


      - name: Verify Platform Packages on npm
        shell: bash
        run: |
          set -euo pipefail

          for platform in npm/platforms/*; do
            if [ -d "$platform" ]; then
              pkg_name="$(node -p "require('./$platform/package.json').name")"
              pkg_version="$(node -p "require('./$platform/package.json').version")"
              attempts=0
              until npm view "$pkg_name@$pkg_version" version >/dev/null 2>&1; do
                attempts=$((attempts + 1))
                if [ "$attempts" -ge 12 ]; then
                  echo "Missing $pkg_name@$pkg_version on npm after ${attempts} checks." >&2
                  exit 1
                fi
                sleep 5
              done
              echo "Verified $pkg_name@$pkg_version on npm."
            fi
          done

      - name: Publish Main Package
        working-directory: npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
